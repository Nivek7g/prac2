<!DOCTYPE html>
<html>
<head>
    <title>Resultados: {{ encuesta.titulo }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1>Resultados: {{ encuesta.titulo }}</h1>

        <div class="card mb-4">
            <div class="card-body">
                <canvas id="graficoResultados" width="400" height="200"></canvas>
            </div>
        </div>

        <h3>Estadísticas</h3>
        {% for pregunta in preguntas %}
        <div class="card mb-2">
            <div class="card-body">
                <h6>P{{ loop.index }}: {{ pregunta.texto_pregunta }}</h6>
                <p>
                    Tipo: {{ pregunta.tipo }} | 
                    Respuestas: {{ estadisticas[loop.index0].total_respuestas }}
                    {% if pregunta.tipo == 'escala' %}
                    | Promedio: {{ "%.2f"|format(estadisticas[loop.index0].promedio) }}/5
                    {% endif %}
                </p>
            </div>
        </div>
        {% endfor %}

        <a href="/encuestas" class="btn btn-primary mt-3">Volver</a>
    </div>

    <script>
        // Obtener el ID de la encuesta desde la URL
        const pathParts = window.location.pathname.split('/');
        const encuestaId = pathParts[2]; // /encuestas/ID/resultados

        console.log("Cargando gráfico para encuesta ID:", encuestaId);

        // Cargar datos via API (usa la ruta que YA existe)
        fetch(`/api/encuestas/${encuestaId}/datos-grafico`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la API');
                }
                return response.json();
            })
            .then(datos => {
                console.log("Datos recibidos:", datos);
                
                const ctx = document.getElementById('graficoResultados').getContext('2d');
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: datos.labels || ['P1'],
                        datasets: [{
                            label: 'Promedio (1-5)',
                            data: datos.promedios || datos.data || [0],
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error cargando datos:', error);
                // Mostrar gráfico con datos de ejemplo
                const ctx = document.getElementById('graficoResultados').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['P1'],
                        datasets: [{
                            label: 'Promedio (1-5)',
                            data: [3.67],
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5
                            }
                        }
                    }
                });
            });
    </script>
</body>
</html>